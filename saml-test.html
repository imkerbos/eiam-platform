<!DOCTYPE html>
<html>
<head>
    <title>SAML IdP 测试页面</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .endpoint { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .test-form { background: #e8f4f8; padding: 20px; border-radius: 5px; margin: 20px 0; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #005a87; }
        .info { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 EIAM SAML IdP 测试页面</h1>
        
        <div class="info">
            <h3>📋 SAML端点信息</h3>
            <div class="endpoint">
                <strong>元数据 URL (通过前端代理):</strong><br>
                <a href="http://localhost:3000/saml/metadata" target="_blank">
                    http://localhost:3000/saml/metadata
                </a>
            </div>
            <div class="endpoint">
                <strong>SSO URL (通过前端代理):</strong><br>
                http://localhost:3000/saml/sso
            </div>
            <div class="endpoint">
                <strong>SLS URL (通过前端代理):</strong><br>
                http://localhost:3000/saml/sls
            </div>
        </div>

        <div class="test-form">
            <h3>🧪 快速测试</h3>
            <p>点击下面的按钮测试SAML元数据是否正常工作：</p>
            <button onclick="testMetadata()">测试元数据端点</button>
            <button onclick="testSSO()">测试SSO端点</button>
            
            <div id="result" style="margin-top: 20px;"></div>
        </div>

        <div class="info">
            <h3>📖 使用说明</h3>
            <ol>
                <li><strong>启动后端服务器:</strong> <code>go run cmd/server/main.go</code></li>
                <li><strong>启动前端服务器:</strong> <code>cd frontend && npm run dev</code></li>
                <li><strong>访问管理界面:</strong> <a href="http://localhost:3000" target="_blank">http://localhost:3000</a></li>
                <li><strong>配置SAML应用:</strong> 控制台 → 应用程序 → 添加应用程序 → 选择SAML</li>
                <li><strong>下载元数据:</strong> 点击上面的"测试元数据端点"按钮</li>
            </ol>
        </div>

        <div class="info">
            <h3>🔗 集成步骤</h3>
            <h4>对于Service Provider (SP)应用:</h4>
            <ol>
                <li>获取IdP元数据: <code>curl http://localhost:3000/saml/metadata</code></li>
                <li>在SP中配置IdP元数据</li>
                <li>在EIAM中注册SP (Entity ID, ACS URL等)</li>
                <li>测试SAML登录流程</li>
            </ol>
        </div>
    </div>

    <script>
        async function testMetadata() {
            const result = document.getElementById('result');
            result.innerHTML = '<p>⏳ 正在测试元数据端点...</p>';
            
            try {
                const response = await fetch('http://localhost:3000/saml/metadata');
                if (response.ok) {
                    const metadata = await response.text();
                    result.innerHTML = `
                        <div style="background: #d4edda; padding: 15px; border-radius: 5px;">
                            <h4>✅ 元数据端点正常工作!</h4>
                            <p><strong>状态码:</strong> ${response.status}</p>
                            <p><strong>内容类型:</strong> ${response.headers.get('content-type')}</p>
                            <details>
                                <summary>查看元数据内容</summary>
                                <pre style="background: #f8f9fa; padding: 10px; overflow-x: auto;">${metadata}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                result.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                        <h4>❌ 元数据端点测试失败</h4>
                        <p><strong>错误:</strong> ${error.message}</p>
                        <p><strong>建议:</strong> 请确保后端服务器已启动 (go run cmd/server/main.go)</p>
                    </div>
                `;
            }
        }

        function testSSO() {
            const result = document.getElementById('result');
            result.innerHTML = `
                <div style="background: #cce5ff; padding: 15px; border-radius: 5px;">
                    <h4>ℹ️ SSO测试说明</h4>
                    <p>SSO端点需要有效的SAML请求才能测试。您可以:</p>
                    <ol>
                        <li>使用在线工具如 <a href="https://samltest.id" target="_blank">samltest.id</a></li>
                        <li>配置一个真实的SP应用</li>
                        <li>使用SAML测试工具生成AuthnRequest</li>
                    </ol>
                    <p><strong>SSO URL:</strong> http://localhost:3000/saml/sso</p>
                </div>
            `;
        }
    </script>
</body>
</html>
