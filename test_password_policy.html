<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>密码策略测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #ddd;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 200px;
        }
        .password-strength {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .strength-1, .strength-2 { background: #ffebee; border: 1px solid #f44336; }
        .strength-3 { background: #fff3e0; border: 1px solid #ff9800; }
        .strength-4 { background: #e3f2fd; border: 1px solid #2196f3; }
        .strength-5 { background: #e8f5e8; border: 1px solid #4caf50; }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .policy-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <h1>🔐 密码策略功能测试</h1>
    
    <div class="test-section">
        <h2>1. 登录获取Token</h2>
        <button onclick="login()">登录</button>
        <div id="login-result"></div>
    </div>

    <div class="test-section">
        <h2>2. 获取当前密码策略</h2>
        <button onclick="getPasswordPolicy()">获取策略</button>
        <div id="policy-result"></div>
    </div>

    <div class="test-section">
        <h2>3. 密码验证测试</h2>
        <div>
            <label>用户名:</label>
            <input type="text" id="username" value="admin" placeholder="输入用户名">
        </div>
        <div>
            <label>密码:</label>
            <input type="password" id="password" placeholder="输入要验证的密码">
        </div>
        <button onclick="validatePassword()">验证密码</button>
        <div id="validation-result"></div>
    </div>

    <div class="test-section">
        <h2>4. 密码生成测试</h2>
        <button onclick="generatePassword()">生成强密码</button>
        <div id="generate-result"></div>
    </div>

    <div class="test-section">
        <h2>5. 更新密码策略</h2>
        <div class="grid">
            <div>
                <h3>密码长度</h3>
                <div class="policy-item">
                    <label>最小长度:</label>
                    <input type="number" id="minLength" value="8" min="6" max="20">
                </div>
                <div class="policy-item">
                    <label>最大长度:</label>
                    <input type="number" id="maxLength" value="128" min="20" max="256">
                </div>
            </div>
            <div>
                <h3>字符要求</h3>
                <div class="policy-item">
                    <label>大写字母:</label>
                    <input type="checkbox" id="requireUpper" checked>
                </div>
                <div class="policy-item">
                    <label>小写字母:</label>
                    <input type="checkbox" id="requireLower" checked>
                </div>
                <div class="policy-item">
                    <label>数字:</label>
                    <input type="checkbox" id="requireNumbers" checked>
                </div>
                <div class="policy-item">
                    <label>特殊字符:</label>
                    <input type="checkbox" id="requireSpecial" checked>
                </div>
            </div>
            <div>
                <h3>安全设置</h3>
                <div class="policy-item">
                    <label>历史记录数:</label>
                    <input type="number" id="historyCount" value="5" min="0" max="20">
                </div>
                <div class="policy-item">
                    <label>过期天数:</label>
                    <input type="number" id="expiryDays" value="90" min="0" max="3650">
                </div>
            </div>
            <div>
                <h3>限制设置</h3>
                <div class="policy-item">
                    <label>防止常见密码:</label>
                    <input type="checkbox" id="preventCommon" checked>
                </div>
                <div class="policy-item">
                    <label>防止包含用户名:</label>
                    <input type="checkbox" id="preventUsername" checked>
                </div>
            </div>
        </div>
        <button onclick="updatePasswordPolicy()">更新策略</button>
        <div id="update-result"></div>
    </div>

    <div class="test-section">
        <h2>6. 用户创建测试</h2>
        <div>
            <label>用户名:</label>
            <input type="text" id="newUsername" placeholder="新用户名">
        </div>
        <div>
            <label>邮箱:</label>
            <input type="email" id="newEmail" placeholder="新用户邮箱">
        </div>
        <div>
            <label>显示名称:</label>
            <input type="text" id="newDisplayName" placeholder="显示名称">
        </div>
        <div>
            <label>密码:</label>
            <input type="password" id="newPassword" placeholder="新用户密码">
        </div>
        <button onclick="createUser()">创建用户</button>
        <div id="create-result"></div>
    </div>

    <script>
        let accessToken = '';

        async function login() {
            const resultDiv = document.getElementById('login-result');
            resultDiv.innerHTML = '<span class="info">正在登录...</span>';
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/console/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.code === 200) {
                    accessToken = data.data.access_token;
                    resultDiv.innerHTML = `
                        <span class="success">✅ 登录成功</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <span class="error">❌ 登录失败</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="error">❌ 登录错误: ${error.message}</span>
                `;
            }
        }

        async function getPasswordPolicy() {
            if (!accessToken) {
                document.getElementById('policy-result').innerHTML = 
                    '<span class="error">❌ 请先登录</span>';
                return;
            }

            const resultDiv = document.getElementById('policy-result');
            resultDiv.innerHTML = '<span class="info">正在获取密码策略...</span>';
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/console/password-policy', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok && data.code === 200) {
                    resultDiv.innerHTML = `
                        <span class="success">✅ 获取密码策略成功</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <span class="error">❌ 获取密码策略失败</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="error">❌ 获取密码策略错误: ${error.message}</span>
                `;
            }
        }

        async function validatePassword() {
            if (!accessToken) {
                document.getElementById('validation-result').innerHTML = 
                    '<span class="error">❌ 请先登录</span>';
                return;
            }

            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;

            if (!password) {
                document.getElementById('validation-result').innerHTML = 
                    '<span class="error">❌ 请输入密码</span>';
                return;
            }

            const resultDiv = document.getElementById('validation-result');
            resultDiv.innerHTML = '<span class="info">正在验证密码...</span>';
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/console/password-policy/validate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: password,
                        username: username
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.code === 200) {
                    const result = data.data;
                    let strengthClass = `strength-${result.strength}`;
                    
                    resultDiv.innerHTML = `
                        <span class="${result.valid ? 'success' : 'error'}">
                            ${result.valid ? '✅ 密码验证通过' : '❌ 密码验证失败'}
                        </span>
                        <div class="password-strength ${strengthClass}">
                            <strong>密码强度: ${result.strength_text} (${result.strength}/5)</strong>
                            <div>颜色: ${result.strength_color}</div>
                        </div>
                        ${result.errors.length > 0 ? `
                            <div class="error">
                                <strong>错误:</strong>
                                <ul>${result.errors.map(err => `<li>${err}</li>`).join('')}</ul>
                            </div>
                        ` : ''}
                        ${result.warnings.length > 0 ? `
                            <div class="warning">
                                <strong>警告:</strong>
                                <ul>${result.warnings.map(warn => `<li>${warn}</li>`).join('')}</ul>
                            </div>
                        ` : ''}
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <span class="error">❌ 密码验证失败</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="error">❌ 密码验证错误: ${error.message}</span>
                `;
            }
        }

        async function generatePassword() {
            if (!accessToken) {
                document.getElementById('generate-result').innerHTML = 
                    '<span class="error">❌ 请先登录</span>';
                return;
            }

            const resultDiv = document.getElementById('generate-result');
            resultDiv.innerHTML = '<span class="info">正在生成密码...</span>';
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/console/password-policy/generate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok && data.code === 200) {
                    resultDiv.innerHTML = `
                        <span class="success">✅ 密码生成成功</span>
                        <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            <strong>生成的密码:</strong> <code>${data.data.password}</code>
                        </div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <span class="error">❌ 密码生成失败</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="error">❌ 密码生成错误: ${error.message}</span>
                `;
            }
        }

        async function updatePasswordPolicy() {
            if (!accessToken) {
                document.getElementById('update-result').innerHTML = 
                    '<span class="error">❌ 请先登录</span>';
                return;
            }

            const resultDiv = document.getElementById('update-result');
            resultDiv.innerHTML = '<span class="info">正在更新密码策略...</span>';
            
            const policy = {
                min_length: parseInt(document.getElementById('minLength').value),
                max_length: parseInt(document.getElementById('maxLength').value),
                require_uppercase: document.getElementById('requireUpper').checked,
                require_lowercase: document.getElementById('requireLower').checked,
                require_numbers: document.getElementById('requireNumbers').checked,
                require_special_chars: document.getElementById('requireSpecial').checked,
                history_count: parseInt(document.getElementById('historyCount').value),
                expiry_days: parseInt(document.getElementById('expiryDays').value),
                prevent_common: document.getElementById('preventCommon').checked,
                prevent_username: document.getElementById('preventUsername').checked,
                is_active: true
            };
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/console/password-policy', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(policy)
                });

                const data = await response.json();
                
                if (response.ok && data.code === 200) {
                    resultDiv.innerHTML = `
                        <span class="success">✅ 密码策略更新成功</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <span class="error">❌ 密码策略更新失败</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="error">❌ 密码策略更新错误: ${error.message}</span>
                `;
            }
        }

        async function createUser() {
            if (!accessToken) {
                document.getElementById('create-result').innerHTML = 
                    '<span class="error">❌ 请先登录</span>';
                return;
            }

            const username = document.getElementById('newUsername').value;
            const email = document.getElementById('newEmail').value;
            const displayName = document.getElementById('newDisplayName').value;
            const password = document.getElementById('newPassword').value;

            if (!username || !email || !displayName || !password) {
                document.getElementById('create-result').innerHTML = 
                    '<span class="error">❌ 请填写所有字段</span>';
                return;
            }

            const resultDiv = document.getElementById('create-result');
            resultDiv.innerHTML = '<span class="info">正在创建用户...</span>';
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/console/users', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        display_name: displayName,
                        password: password,
                        organization_id: 'eed08673-a72b-4751-85cf-41993e48bfbb'
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.code === 201) {
                    resultDiv.innerHTML = `
                        <span class="success">✅ 用户创建成功</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <span class="error">❌ 用户创建失败</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <span class="error">❌ 用户创建错误: ${error.message}</span>
                `;
            }
        }
    </script>
</body>
</html>
